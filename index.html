<!DOCTYPE html>
<html>
<head>
    <title>Congrats on 10k!</title>
    <style>
       
        body { margin: 0; overflow: hidden; background: #222; }
        canvas { display: block; }
        #bottomGif {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 250px;
            z-index: 10;
            pointer-events: none; 
}


        }
        #playBtn {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 100;
            padding: 8px 16px;
            font-size: 14px;
            background-color: #ffd700;
            color: #222;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<img id="bottomGif" src="https://media.tenor.com/j_MxsHf3fXIAAAAM/clash-royale-clash-mini.gif">

<button id="playBtn">Play Music</button>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { FontLoader } from 'three/addons/loaders/FontLoader.js';
import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';

function fixWinding(font) {
    const glyphs = font.data.glyphs;
    if (!glyphs) return;

    for (const key in glyphs) {
        const g = glyphs[key];
        if (!g.o) continue;

        const tokens = g.o.trim().split(/\s+/);
        let subpaths = [];
        let current = [];

        // Split into individual paths
        tokens.forEach(cmd => {
            current.push(cmd);
            if (cmd === "z") {
                subpaths.push([...current]);
                current = [];
            }
        });

        // Convert each path to numeric coordinate arrays for area calc
        function pathToPoints(path) {
            const pts = [];
            for (let i = 0; i < path.length; i++) {
                const cmd = path[i];
                if (cmd === "m" || cmd === "l" || cmd === "b") {
                    const x = parseFloat(path[i+1]);
                    const y = parseFloat(path[i+2]);
                    pts.push([x, y]);
                }
            }
            return pts;
        }

        // Calculate signed area
        function signedArea(pts) {
            let area = 0;
            for (let i = 0; i < pts.length; i++) {
                const [x1, y1] = pts[i];
                const [x2, y2] = pts[(i + 1) % pts.length];
                area += (x1 * y2 - x2 * y1);
            }
            return area / 2;
        }

        const fixedPaths = subpaths.map(path => {
            const pts = pathToPoints(path);
            if (pts.length < 3) return path;
            const area = signedArea(pts);
            if (area < 0) return path.reverse();
            return path;
        });

        g.o = fixedPaths.map(p => p.join(" ")).join(" ");
    }
}
    
/* Scene */
const scene = new THREE.Scene();

/* Background */
const loader = new THREE.TextureLoader();
loader.load(
    "https://support.supercell.com/images/_sidebarPortrait/CR-hamburger-for-portrait.jpg?v=1762334933",
    tex => scene.background = tex
);

/* Camera */
const camera = new THREE.PerspectiveCamera(
    window.innerWidth < 600 ? 85 : 75,
    window.innerWidth / window.innerHeight,
    0.1,
    1000
);
camera.position.set(0, 8, 15);
camera.lookAt(0, 4, 0);

/* AUDIO SETUP */
const listener = new THREE.AudioListener();
camera.add(listener);

const sound = new THREE.Audio(listener);
const audioLoader = new THREE.AudioLoader();
audioLoader.load('Celebration.mp3', buffer => {
    sound.setBuffer(buffer);
    sound.setLoop(true);
    sound.setVolume(0.45);
});

const playBtn = document.getElementById('playBtn');
function startAudio() {
    if (!sound.isPlaying) sound.play();
    playBtn.style.display = 'none';
    window.removeEventListener('click', startAudio);
    window.removeEventListener('touchstart', startAudio);
}
playBtn.addEventListener('click', startAudio);
window.addEventListener('click', startAudio);
window.addEventListener('touchstart', startAudio);

// Mute/unmute toggle
window.addEventListener('keydown', e => {
    if (e.key === 'm') sound.setVolume(sound.getVolume() > 0 ? 0 : 0.45);
});

/* Renderer */
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

/* Controls */
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

/* Materials */
const blueMaterial = new THREE.MeshStandardMaterial({ color: 0x228BEE, roughness: 0.4, metalness: 0.3 });
const goldMaterial = new THREE.MeshStandardMaterial({
    color: 0xFFD700,
    metalness: 0.1,       // MUCH lower
    roughness: 0.45,      // softer reflection
    side: THREE.DoubleSide // << fixes invisible letters
});


const cakeHeight = 3;
const cakeRadius = 3;

/* CAKE */
const cakeMesh = new THREE.Mesh(
    new THREE.CylinderGeometry(cakeRadius, cakeRadius, cakeHeight, 64),
    blueMaterial
);
cakeMesh.position.y = cakeHeight / 2;
scene.add(cakeMesh);

/* Shells Function */
function createShellGeometry() {
    const group = new THREE.Group();
    const frontGeo = new THREE.SphereGeometry(0.32, 32, 32);
    const front = new THREE.Mesh(frontGeo, goldMaterial);
    front.scale.set(1.2, 0.8, 1.2);
    group.add(front);

    const tailGeo = new THREE.ConeGeometry(0.32, 0.55, 32);
    const tail = new THREE.Mesh(tailGeo, goldMaterial);
    tail.rotation.x = Math.PI / 2;
    tail.position.z = -0.28;
    tail.scale.set(1.1, 0.7, 1.0);
    group.add(tail);
    return group;
}

/* Top Shell Border */
const topBorder = new THREE.Group();
scene.add(topBorder);
for (let i = 0; i < 34; i++) {
    const angle = (i / 34) * Math.PI * 2;
    const s = createShellGeometry();
    s.position.set(Math.cos(angle) * cakeRadius * 0.92, cakeHeight + 0.1, Math.sin(angle) * cakeRadius * 0.92);
    s.lookAt(0, cakeHeight + 0.1, 0);
    topBorder.add(s);
}

/* Bottom Shell Border */
const bottomBorder = new THREE.Group();
scene.add(bottomBorder);
for (let i = 0; i < 40; i++) {
    const angle = (i / 40) * Math.PI * 2;
    const s = createShellGeometry();
    s.scale.set(1.25, 1.25, 1.25);
    s.position.set(Math.cos(angle) * cakeRadius * 0.96, 0.12, Math.sin(angle) * cakeRadius * 0.96);
    s.lookAt(0, 0.12, 0);
    bottomBorder.add(s);
}

/* FLOATING TEXT */
const fontLoader = new FontLoader(); fontLoader.load( "https://threejs.org/examples/fonts/helvetiker_regular.typeface.json", font => { const textGeo = new TextGeometry("CONGRATS ON 10,000!!!", { font: font, size: 0.8, height: 0.2 }); textGeo.center(); const textMesh = new THREE.Mesh(textGeo, goldMaterial); textMesh.position.y = cakeHeight + 3.5; scene.add(textMesh); } );

    
/* CONFETTI */
const confettiGroup = new THREE.Group();
scene.add(confettiGroup);
const confTexture = loader.load("https://cdn-assets-eu.frontify.com/s3/frontify-enterprise-files-eu/eyJwYXRoIjoic3VwZXJjZWxsXC9maWxlXC9tMXhSaDhjaFdHUlV5QTVCY3VXQS5wbmcifQ:supercell:mkFfx_gE1E8FQFQzbmfTZAZRsdfi86EisecMfN-klJU?width=2400");

function createConfetti() {
    const geo = new THREE.PlaneGeometry(0.5, 0.5);
    const mat = new THREE.MeshBasicMaterial({ map: confTexture, transparent: true });
    const c = new THREE.Mesh(geo, mat);
    c.position.set((Math.random() - 0.5) * 20, Math.random() * 10 + 5, (Math.random() - 0.5) * 20);
    c.fallSpeed = Math.random() * 0.05 + 0.02;
    c.rotationSpeed = Math.random() * 0.05;
    confettiGroup.add(c);
}
for (let i = 0; i < 100; i++) createConfetti();

/* TOPPERS */
const topperGroup = new THREE.Group();
scene.add(topperGroup);
const textureLoader = new THREE.TextureLoader();
const topperImageURLs = [
    "https://cdn-assets-eu.frontify.com/s3/frontify-enterprise-files-eu/eyJwYXRoIjoic3VwZXJjZWxsXC9maWxlXC9XWG8xNXVSR2JYNWV2dWE5QzltaC5wbmcifQ:supercell:r4DzRtvyswMVOrHvTh6QiiFScO9sEMEGvYjOyyy0fGE?width=2400",
    "https://cdn-assets-eu.frontify.com/s3/frontify-enterprise-files-eu/eyJwYXRoIjoic3VwZXJjZWxsXC9maWxlXC9LbUtDQndaMnZVbnRBc2g5Z1pHTi5wbmcifQ:supercell:F_AVdzyT_vkz49YKP2EkdHIwJ2bjDARldFFA8uLb14A?width=2400",
    "https://cdn-assets-eu.frontify.com/s3/frontify-enterprise-files-eu/eyJwYXRoIjoic3VwZXJjZWxsXC9maWxlXC9qRjYzOGlIbWJpS1FFM010dlV1dC5wbmcifQ:supercell:tcrdoGKhtUxp2p_cD-6-kWmWLZ6abJ09QGu4hGhpb3k?width=2400"
];
const topperTextures = topperImageURLs.map(url => textureLoader.load(url));
const topperSpacing = 2.2;
const startX = -(topperTextures.length - 1) * topperSpacing * 0.5;

topperTextures.forEach((tex, i) => {
    const stick = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 2), new THREE.MeshStandardMaterial({ color: 0x804000 }));
    stick.position.set(startX + i * topperSpacing, cakeHeight + 0.4, 0);

    const topperPlane = new THREE.Mesh(new THREE.PlaneGeometry(2, 2.2), new THREE.MeshStandardMaterial({ map: tex, transparent: true }));
    topperPlane.position.set(startX + i * topperSpacing, cakeHeight + 1.5, 0);
    topperPlane.lookAt(camera.position);

    const g = new THREE.Group();
    g.add(stick);
    g.add(topperPlane);
    topperGroup.add(g);
});

/* LIGHTS */
scene.add(new THREE.AmbientLight(0xffffff, 0.8));
const dl = new THREE.DirectionalLight(0xffffff, 1.5);
dl.position.set(5, 15, 10);
scene.add(dl);

/* ANIMATE */
function animate() {
    requestAnimationFrame(animate);
    confettiGroup.children.forEach(c => {
        c.position.y -= c.fallSpeed;
        c.rotation.x += c.rotationSpeed;
        c.rotation.y += c.rotationSpeed;
        if (c.position.y < -1) c.position.y = Math.random() * 10 + 5;
    });
    controls.update();
    renderer.render(scene, camera);
}
animate();

/* RESIZE */
window.addEventListener("resize", () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
